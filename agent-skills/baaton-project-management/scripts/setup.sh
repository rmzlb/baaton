#!/usr/bin/env bash
# Baaton Setup â€” Interactive configuration for API access
#
# Creates a .baaton config file in the current directory
# Tests the connection and shows available projects

set -euo pipefail

echo "ðŸŽ¯ Baaton Setup"
echo "==============="
echo ""

# â”€â”€â”€ API URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

read -rp "API URL [https://api.baaton.dev]: " API_URL
API_URL="${API_URL:-https://api.baaton.dev}"

# â”€â”€â”€ API Key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo ""
echo "Get your API key from: ${API_URL/api./} â†’ Project Settings â†’ API Keys"
read -rp "API Key (baa_...): " API_KEY

if [ -z "$API_KEY" ]; then
  echo "Error: API key is required" >&2
  exit 1
fi

if [[ ! "$API_KEY" == baa_* ]]; then
  echo "Warning: API key doesn't start with 'baa_' â€” are you sure it's correct?"
  read -rp "Continue anyway? [y/N]: " confirm
  [[ "$confirm" =~ ^[Yy] ]] || exit 1
fi

# â”€â”€â”€ Test Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo ""
echo "Testing connection..."

HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
  "${API_URL}/api/v1/projects" \
  -H "Authorization: Bearer ${API_KEY}" \
  -H "Content-Type: application/json" 2>/dev/null)

if [ "$HTTP_CODE" -eq 200 ]; then
  echo "âœ… Connected successfully!"
elif [ "$HTTP_CODE" -eq 401 ]; then
  echo "âŒ Authentication failed â€” check your API key" >&2
  exit 1
elif [ "$HTTP_CODE" -eq 000 ]; then
  echo "âŒ Could not reach ${API_URL} â€” check the URL" >&2
  exit 1
else
  echo "âš ï¸  Got HTTP $HTTP_CODE â€” connection may have issues"
fi

# â”€â”€â”€ Show Projects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo ""
echo "Available projects:"
echo "-------------------"

PROJECTS=$(curl -s "${API_URL}/api/v1/projects" \
  -H "Authorization: Bearer ${API_KEY}" \
  -H "Content-Type: application/json" 2>/dev/null)

if command -v jq &>/dev/null; then
  echo "$PROJECTS" | jq -r '.data[] | "  \(.id)  \(.prefix)-*  \(.name)"' 2>/dev/null || echo "  (no projects found)"
else
  echo "$PROJECTS"
fi

# â”€â”€â”€ Select Project â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo ""
read -rp "Project ID to use (or press Enter to skip): " PROJECT_ID

# â”€â”€â”€ Write Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

CONFIG_FILE=".baaton"
cat > "$CONFIG_FILE" <<EOF
# Baaton configuration
# Generated by setup.sh on $(date -u +%Y-%m-%dT%H:%M:%SZ)
api_url=${API_URL}
api_key=${API_KEY}
EOF

if [ -n "$PROJECT_ID" ]; then
  echo "project_id=${PROJECT_ID}" >> "$CONFIG_FILE"
fi

echo ""
echo "âœ… Config saved to ${CONFIG_FILE}"
echo ""
echo "Add .baaton to your .gitignore (contains API key):"
echo '  echo ".baaton" >> .gitignore'
echo ""
echo "Usage:"
echo "  export BAATON_API_KEY=${API_KEY}"
echo "  # or let scripts auto-detect .baaton file"
